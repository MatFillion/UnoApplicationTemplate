parameters:
  appCenterUWPSlug: ''
  appCenteriOSSlug: ''
  appCenterAndroidSlug: ''
  deploymentEnvironment: ''

jobs:
- deployment: AppCenter_UWP
  pool: $(windowsPoolName)

  environment: ${{ parameters.deploymentEnvironment }}

  container: windows

  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: none

        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: current
            downloadType: single
            artifactName: $(UWPArtifactName)
            
        - task: AppCenterDistribute@3
          displayName: Deploy UWP to AppCenter
          inputs:
            serverEndpoint: $(AppCenterServiceConnection)
            appSlug: ${{ parameters.appCenterUWPSlug }}
            appFile: $(System.ArtifactsDirectory)/$(UWPArtifactName)/*.msixbundle
            releaseNotesInput: |
              CI build
            isSilent: true

- deployment: AppCenter_iOS
  pool: 
    name: $(macOSPoolName)
    demands:
    - fastlane

  environment: ${{ parameters.deploymentEnvironment }}

  variables:
  - group: ApplicationTemplate.Distribution.AppStore

  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: none

        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: current
            downloadType: single
            artifactName: $(iOSArtifactName)

        - task: AppCenterDistribute@3
          displayName: Deploy iOS to AppCenter
          inputs:
            serverEndpoint: $(AppCenterServiceConnection)
            appSlug: ${{ parameters.appCenteriOSSlug }}
            appFile: $(System.ArtifactsDirectory)/$(iOSArtifactName)/*.ipa
            symbolsDsymFiles: $(System.ArtifactsDirectory)/$(iOSArtifactName)/*.dSYM
            symbolsIncludeParentDirectory: true
            releaseNotesInput: |
              CI build
            isSilent: true

- deployment: AppCenter_Android
  pool: $(windowsPoolName)

  variables:
  - group: ApplicationTemplate.Distribution.GooglePlay
    
  environment: ${{ parameters.deploymentEnvironment }}

  container: windows
  
  strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none

          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: current
              downloadType: single
              artifactName: $(AndroidArtifactName)

          - task: DownloadSecureFile@1
            name: keyStore
            displayName: "Download keystore from secure files"
            inputs:
              secureFile: $(GooglePlayKeystore)

          - task: InstallBundletool@1

          - task: AabConvertToUniversalApk@1
            inputs:
              aabFilePath: '$(System.ArtifactsDirectory)/$(AndroidArtifactName)/*-Signed.aab'
              keystoreFilePath: '$(keyStore.secureFilePath)'
              keystorePassword: '$(AndroidSigningStorePass)'
              keystoreAlias: '$(AndroidSigningKeyAlias)'
              keystoreAliasPassword: '$(AndroidSigningKeyPass)'
              outputFolder: '$(Build.SourcesDirectory)/tmp'
          
          - task: AppCenterDistribute@3
            displayName: Deploy Android to AppCenter
            inputs:
              serverEndpoint: $(AppCenterServiceConnection)
              appSlug: ${{ parameters.appCenterAndroidSlug }}
              appFile: '$(Build.SourcesDirectory)/tmp/*.apk'
              releaseNotesInput: |
                CI build
              isSilent: true